<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Musikfolge</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
        <link href="stylesheet.css" rel="stylesheet" type="text/css">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>
    </head>
    <body>
        <!--Modal edit Vereinsdaten -->
        <div class="modal fade" id="modalVereinsdaten" tabindex="-1" aria-labelledby="modalVereinsdatenLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Vereinsdaten</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col">
                                <label class="form-label">Name des Vereins</label>
                                <input type="text" class="form-control" id="inputVereinName">
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <label class="form-label">Musikleiter</label>
                            <div class="col-6">
                                <label class="form-label">Vorname</label>
                                <input type="text" class="form-control" id="inputVereinMusikleiterVorname">
                            </div>
                            <div class="col-6">
                                <label class="form-label">Nachname</label>
                                <input type="text" class="form-control" id="inputVereinMusikleiterNachname">
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <label class="form-label">Anschrift</label>
                            <div class="col-9">
                                <label class="form-label">Straße</label>
                                <input type="text" class="form-control" id="inputVereinStraße">
                            </div>
                            <div class="col-3">
                                <label class="form-label">Hausnummer</label>
                                <input type="text" class="form-control" id="inputVereinHausnr">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-3">
                                <label class="form-label">PLZ</label>
                                <input type="text" class="form-control" id="inputVereinPlz">
                            </div>
                            <div class="col-9">
                                <label class="form-label">Ort</label>
                                <input type="text" class="form-control" id="inputVereinOrt">
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-4">
                                <label class="form-label">Anzahl der Musizierenden</label>
                                <input type="text" class="form-control" id="inputVereinAnzahl">
                            </div>
                            <div class="col-4">
                                <label class="form-label">Art der Besetzung</label>
                                <input type="text" class="form-control" id="inputVereinBesetzung">
                            </div>
                            <div class="col-4">
                                <label class="form-label">GEMA-Mitglieds-Nr</label>
                                <input type="text" class="form-control" id="inputVereinGemaNr">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" id="btnSaveVereinsdaten">Speichern</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="wrapper">
            <div class="header bg-dark">
                <div class="container py-3">
                    <div class="row">
                        <div class="col">
                            <h4 class="text-white fw-light">Musikfolge</h4>
                        </div>
                        <div class="col">
                            <a href=index.html>
                                <button type="button" class="btn btn-primary w-100" id ="ListeBearbeiten">Titel bearbeiten</button>
                            </a>
                        </div>
                        <div class="col">
                            <a href=gemaListe.html>
                                <button type="button" class="btn btn-danger w-100" id="GemaListe">Liste erstellen</button>
                            </a>
                        </div>
                        <div class="col">
                            <a href=verwaltung.html>
                                <button type="button" class="btn btn-primary w-100" id="VereinsDaten">Verwaltung</button>
                            </a>
                        </div>
                        <div class="col"></div>
                    </div>
                </div>
            </div>

            <div class="content-header container">
                <div class="row my-3">
                    <div class="col-4">
                        <input class="form-control" type="text" name="search" placeholder="Suche" id="inputSearch">
                    </div>
                </div>
                <hr>
            </div>

            <div class="content-scroll-table container">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr class="table-secondary">
                            <th></th>
                            <th>Titel</th>
                            <th>Komponist</th>
                            <th>Bearbeiter</th>
                            <th>Verlag</th>
                        </tr>
                    </thead>
                    <tbody id="table-titles">
                    </tbody>
                </table>
            </div>

            <div class="footer bg-dark">
                <div class="container text-center py-3">
                    <div class="row justify-content-center">
                        <div class="col-6 col-md-4">
                            <button type="button" class="btn btn-secondary w-100" id="btnVereinsdatenAendern">Vereinsdaten ändern</button>
                        </div>
                        <div class="col-6 col-md-4">
                            <button type="button" class="btn btn-secondary w-100" id="btnCreateGemaListe" disabled>GEMA-Liste erstellen</button>
                        </div>
                    </div>
                    <div class="d-flex justify-content-center pt-3">
                        <a class="text-decoration-none text-white" href="impressum.html">Impressum</a>
                    </div>
                </div>
            </div>
        </div>
    </body>

    <script>
        const inputSearch = document.querySelector("#inputSearch");
        const inputVereinName = document.querySelector("#inputVereinName");
        const inputVereinMusikleiterVorname = document.querySelector("#inputVereinMusikleiterVorname");
        const inputVereinMusikleiterNachname = document.querySelector("#inputVereinMusikleiterNachname");
        const inputVereinStraße = document.querySelector("#inputVereinStraße");
        const inputVereinHausnr = document.querySelector("#inputVereinHausnr");
        const inputVereinPlz = document.querySelector("#inputVereinPlz");
        const inputVereinOrt = document.querySelector("#inputVereinOrt");
        const inputVereinAnzahl = document.querySelector("#inputVereinAnzahl");
        const inputVereinBesetzung = document.querySelector("#inputVereinBesetzung");
        const inputVereinGemaNr = document.querySelector("#inputVereinGemaNr");

        const formGemaListe = document.querySelector("#formGemaListe");

        const modalVereinsdaten = new bootstrap.Modal("#modalVereinsdaten");

        const btnVereinsdaten = document.querySelector('#btnVereinsdatenAendern');
        const btnGemaListe = document.querySelector('#btnCreateGemaListe');
        const btnSaveVereinsdaten = document.querySelector('#btnSaveVereinsdaten');

        const tableTitles = document.querySelector('#table-titles');
        const tableTitlesPopup = document.querySelector('#table-titles-popup');
        

        window.addEventListener("DOMContentLoaded", (event) => {
            init();

            btnVereinsdaten.addEventListener("click", showVereinsdaten);

            btnGemaListe.addEventListener("click", (event) => {
                const items = getSelectedItems();
                encodedTitlesStr = btoa(JSON.stringify(items));
                window.open("./erzeugteGemaListe.html?titles=" + encodedTitlesStr, '_blank').focus();
            });

            btnSaveVereinsdaten.addEventListener("click", saveVereinsdaten);

            inputSearch.addEventListener("input", (event) => {
                searchTitle();
            });
        });

        async function init() {
            // Load titles from Backend
            const titlesArr = await fetch('http://localhost:8000/api/lied/alle')
                .then((response) => response.json());

            // Create table row elements
            titlesArr.forEach((title) => {
                addTableEntry(title);
            });

            updateButtonStates();
        }

        function getSelectedItems() {
            let selectedElements = document.querySelectorAll("tr.selected");
            let items = [];
            selectedElements.forEach((element) => {
                items.push(element.dataset);
            });
            return items;
        }

        function createTableEntry(titleObj) {
            let tr = document.createElement("tr");
            tr.setAttribute("id", "table-row-title-" + titleObj.id);
            tr.addEventListener("click", () => {
                const checkbox = document.querySelector("#checkbox-title-" + titleObj.id);

                if (tr.classList.contains("selected")) {
                    tr.classList.remove("selected");
                    checkbox.checked = false;
                } else {
                    tr.classList.add("selected");
                    checkbox.checked = true;
                }

                updateButtonStates();
            });
            
            let tdCheckbox = document.createElement("td");
            let inputCheckbox = document.createElement("input");
            inputCheckbox.classList.add("form-check-input");
            inputCheckbox.setAttribute("type", "checkbox");
            inputCheckbox.setAttribute("id", "checkbox-title-" + titleObj.id);
            tdCheckbox.appendChild(inputCheckbox);
            tr.appendChild(tdCheckbox);

            let tdTitel = document.createElement("td");
            tdTitel.innerText = titleObj.titel;
            tr.appendChild(tdTitel);

            let tdKomponist = document.createElement("td");
            tdKomponist.innerText = titleObj.komponist_name;
            tr.appendChild(tdKomponist);

            let tdBearbeiter = document.createElement("td");
            tdBearbeiter.innerText = titleObj.bearbeiter_name;
            tr.appendChild(tdBearbeiter);

            let tdVerlag = document.createElement("td");
            tdVerlag.innerText = titleObj.verlag_name;
            tr.appendChild(tdVerlag);

            tr.dataset.id = titleObj.id;
            tr.dataset.titel = titleObj.titel;
            tr.dataset.komponist_id = titleObj.komponist_id;
            tr.dataset.komponist_name = titleObj.komponist_name;
            tr.dataset.bearbeiter_id = titleObj.bearbeiter_id;
            tr.dataset.bearbeiter_name = titleObj.bearbeiter_name;
            tr.dataset.verlag_id = titleObj.verlag_id;
            tr.dataset.verlag_name = titleObj.verlag_name;

            return tr;
        }

        function addTableEntry(titleObj) {
            tableTitles.appendChild(createTableEntry(titleObj));
        }

        function updateButtonStates() {
            let selectedElements = document.querySelectorAll("tr.selected");

            if (selectedElements.length == 0) {
                btnGemaListe.disabled = true;
            } else if (selectedElements.length >= 1) {
                btnGemaListe.disabled = false;
            }
        }

        function addOptionsToSelectElement(selectElement, optionsArr) {
            optionsArr.forEach((option) => {
                let optionElem = document.createElement("option");
                optionElem.value = option.id;
                optionElem.innerText = option.name;
                selectElement.appendChild(optionElem);
            });
        }

        async function showVereinsdaten() {
            // Load data from Backend
            const result = await fetch('http://localhost:8000/api/verein/gib/1')
                .then((response) => response.json());
            console.log(result);

            if (result.fehler) {
                modalVereinsdaten.show();
                return;
            }

            inputVereinName.value = result.name;
            inputVereinMusikleiterVorname.value = result.musikleitervorname;
            inputVereinMusikleiterNachname.value = result.musikleiternachname;
            inputVereinStraße.value = result.anschrift.straße;
            inputVereinHausnr.value = result.anschrift.hausnr;
            inputVereinPlz.value = result.anschrift.plz;
            inputVereinOrt.value = result.anschrift.ort;
            inputVereinAnzahl.value = result.anzahlMusiker;
            inputVereinBesetzung.value = result.besetzung;
            inputVereinGemaNr.value = result.mitgliedsnr;

            modalVereinsdaten.show();
        }

        async function saveVereinsdaten() {
            // Save Anschrift
            bodyObj = {};

            bodyObj.id = 1;
            bodyObj.strasse = inputVereinStraße.value;
            bodyObj.hausnr = inputVereinHausnr.value;
            bodyObj.plz = inputVereinPlz.value;
            bodyObj.ort = inputVereinOrt.value;

            console.log(bodyObj);

            const responseAnschrift = await fetch("http://localhost:8000/api/anschrift", {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(bodyObj)
            })
            .then((response) => response.json().then((data) => (
                {
                    status: response.status,
                    body: data
                }
            )));

            console.log(responseAnschrift);

            // Save Verein
            bodyObj = {};

            bodyObj.id = 1;
            bodyObj.name = inputVereinName.value;
            bodyObj.musikleitervorname = inputVereinMusikleiterVorname.value;
            bodyObj.musikleiternachname = inputVereinMusikleiterNachname.value;
            bodyObj.anschrift = {};
            bodyObj.anschrift.id = 1;
            bodyObj.anzahlMusiker = inputVereinAnzahl.value;
            bodyObj.besetzung = inputVereinBesetzung.value;
            bodyObj.mitgliedsnr = inputVereinGemaNr.value;

            console.log(bodyObj);

            const responseVerein = await fetch("http://localhost:8000/api/verein", {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(bodyObj)
            })
            .then((response) => response.json().then((data) => (
                {
                    status: response.status,
                    body: data
                }
            )));

            console.log(responseVerein);

            modalVereinsdaten.hide();
        }

        async function searchTitle() {
            // Remove old table entries
            tableTitles.innerHTML = "";
            
            // Get matched titles from Backend
            let apiLink = "http://localhost:8000/api/lied/such/" + inputSearch.value;
            // If search input is empty get all titles
            if (inputSearch.value.trim() == "") {
                apiLink = "http://localhost:8000/api/lied/alle";
            }
            const titlesArr = await fetch(apiLink)
                .then((response) => response.json());

            // Create table row elements
            titlesArr.forEach((title) => {
                addTableEntry(title);
            });

            updateButtonStates();
        }
    </script>
</html>