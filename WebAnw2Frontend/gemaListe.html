<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Musikfolge</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
        <link href="stylesheet.css" rel="stylesheet" type="text/css">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>
        
    </head>
    <body>
        <div class="wrapper">
            <div class="header bg-dark">
                <div class="container py-3">
                    <div class="row">
                        <div class="col">
                            <h4 class="text-white fw-light">Musikfolge</h4>
                        </div>
                        <div class="col">
                            <a href=index.html>
                                <button type="button" class="btn btn-primary w-100" id ="ListeBearbeiten">Titel bearbeiten</button>
                            </a>
                        </div>
                        <div class="col">
                            <a href=gemaListe.html>
                                <button type="button" class="btn btn-danger w-100" id="GemaListe">Liste erstellen</button>
                            </a>
                        </div>
                        <div class="col">
                            <a href=verwaltung.html>
                                <button type="button" class="btn btn-primary w-100" id="VereinsDaten">Verwaltung</button>
                            </a>
                        </div>
                        <div class="col"></div>
                    </div>
                </div>
            </div>

            <div class="content-header container">
                <div class="row my-3">
                    <div class="col-4">
                        <input class="form-control" type="text" name="search" placeholder="Suche" id="inputSearch">
                    </div>
                </div>
                <hr>
            </div>

            <div class="content-scroll-table container">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr class="table-secondary">
                            <th></th>
                            <th>Titel</th>
                            <th>Komponist</th>
                            <th>Bearbeiter</th>
                            <th>Verlag</th>
                        </tr>
                    </thead>
                    <tbody id="table-titles">
                    </tbody>
                </table>
            </div>

            <div class="footer bg-dark">
                <div class="container text-center py-3">
                    <div class="row justify-content-center">
                        <div class="col-6 col-md-4">
                            <button id="btn-vereinsdaten-aendern" type="button" class="btn btn-secondary w-100" data-bs-toggle="modal" data-bs-target="#modalVereinsdaten">Vereinsdaten ändern</button>
                        </div>
                        <div class="col-6 col-md-4">
                            <button type="button" class="btn btn-secondary w-100" id="btnCreateGemaListe" disabled>GEMA-Liste erstellen</button>
                        </div>
                    </div>
                    <div class="d-flex justify-content-center pt-3">
                        <a class="text-decoration-none text-white" href="impressum.html">Impressum</a>
                    </div>
                </div>
            </div>
        </div>
        <!--Modal edit Vereinsdaten -->
        <div class="bd-example bg-light">
            <div class="modal fade" id="modalVereinsdaten" tabindex="-1" aria-labelledby="modalVereinsdatenLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Vereinsdaten</h5>
                            <a href="gemaListe.html" class="text-decoration-none-text-body">
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </a>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label" >Name der Kapelle</label>
                                <input type="text" class="form-control" id="NameKapelle">
                            </div>
                            <div class="mb-3">
                                <label  class="form-label" >Name des Musikleiters</label>
                                <br/>
                                <label  class="form-label" >Vorname</label>
                                <input type="text" class="form-control" id="MusikleiterVname">
                                <label  class="form-label" >Nachname</label>
                                <input type="text" class="form-control" id="MusikleiterNname">
                            </div>
                            <div class="mb-3">
                                <label class="form-label" >Anschrift</label>   
                                <br/>
                                <label class="form-label" >Straße</label>
                                <input type="text" class="form-control" id="StrasseVerein">
                                <label class="form-label" >Hausnummer</label>
                                <input type="text" class="form-control" id="HNrVerein">
                                <label class="form-label" >Plz</label>
                                <input type="text" class="form-control" id="PlzVerein">
                                <label class="form-label" >Ort</label>
                                <input type="text" class="form-control" id="OrtVerein">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Anzahl der Musizierenden</label>
                                <input type="number" class="form-control" id="AnzMusizierende">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Art der Besetzung</label>
                                <select class="form-select" aria-lable="Default select" id="Besetzung">
                                    <option id="bo" value="Blasorchester" selected>Blasorchester</option>
                                    <option id="bb" value="Big Band">Big Band</option>
                                    <option id="ko" value="Kammerorchester">Kammerorchester</option>
                                    <option id="po" value="Posaunenchor">Posaunenchor</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">GEMA-Mitglieds-Nr.</label>
                                <input type="text" class="form-control" id="GemaMitgliedNr">
                            </div>
                            <div class="modal-footer">
                                <a href="gemaListe.html" class="text-decoration-none-text-body">
                                    <button type="button" class="btn btn-primary" id="btn_save_Vereinsdaten">speichern</button>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="modalGemaListe" tabindex="-1" aria-labelledby="modalGemaListeLable" aria-hidden="true">
            <div class="modal-dialog modal-fullscreen">
                <div class="modal-content">
                    <div class="modal-header noPrint">
                        <h1 class="modal-title fs-5" id="modalGemaListeLable">GEMA-Liste</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col">
                                <h4>GEMA-Musikfolge</h4>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <h5>Angaben zur Veranstaltung</h5>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <label class="form-label">Name des Veranstalters</label>
                                <input type="text" class="form-control">
                            </div>
                        </div>
                        <div class="row pt-3">
                            <label class="form-label">Anschrift</label>
                            <div class="col-9">
                                <label class="form-label">Straße</label>
                                <input type="text" class="form-control">
                            </div>
                            <div class="col-3">
                                <label class="form-label">Hausnummer</label>
                                <input type="text" class="form-control">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-3">
                                <label class="form-label">PLZ</label>
                                <input type="text" class="form-control">
                            </div>
                            <div class="col-9">
                                <label class="form-label">Ort</label>
                                <input type="text" class="form-control">
                            </div>
                        </div>
                        <div class="row pt-3">
                            <div class="col-6">
                                <label class="form-label">Art der Veranstaltung</label>
                                <select class="form-select">
                                    <option selected>Frühschoppen</option>
                                    <option>Feierabendhock</option>
                                    <option>Konzert</option>
                                </select>
                            </div>
                        </div>
                        <div class="row pt-3">
                            <label class="form-label">Zeitpunkt der Veranstaltung</label>
                            <div class="col-4">
                                <label class="form-label">Datum</label>
                                <input type="text" class="form-control">
                            </div>
                            <div class="col-4">
                                <label class="form-label">Uhrzeit</label>
                                <input type="text" class="form-control">
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <h5>Angaben zum Verein</h5>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <label class="form-label">Name des Vereins</label>
                                <input type="text" class="form-control">
                            </div>
                            <div class="col-6">
                                <label class="form-label">Name des Musikleiters</label>
                                <input type="text" class="form-control">
                            </div>
                        </div>
                        <div class="row pt-3">
                            <label class="form-label">Anschrift</label>
                            <div class="col-9">
                                <label class="form-label">Straße</label>
                                <input type="text" class="form-control">
                            </div>
                            <div class="col-3">
                                <label class="form-label">Hausnummer</label>
                                <input type="text" class="form-control">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-3">
                                <label class="form-label">PLZ</label>
                                <input type="text" class="form-control">
                            </div>
                            <div class="col-9">
                                <label class="form-label">Ort</label>
                                <input type="text" class="form-control">
                            </div>
                        </div>
                        <div class="row pt-3">
                            <div class="col-4">
                                <label class="form-label">Anzahl der Musizierenden</label>
                                <input type="text" class="form-control" value="35">
                            </div>
                            <div class="col-4">
                                <label class="form-label">Art der Besetzung</label>
                                <input type="text" class="form-control" value="Blasorchester">
                            </div>
                            <div class="col-4">
                                <label class="form-label">GEMA-Mitglieds-Nr</label>
                                <input type="text" class="form-control" value="234567">
                            </div>
                        </div>
                        <hr class="noPrint">
                        <div class="row">
                            <h5>Angaben zur Musiknutzung</h5>
                        </div>
                        <table class="table table-striped">
                            <thead>
                                <tr class="table-secondary">
                                    <th></th>
                                    <th>Titel</th>
                                    <th>Komponist</th>
                                    <th>Bearbeiter</th>
                                    <th>Verlag</th>
                                </tr>
                            </thead>
                            <tbody id="table-titles-popup">
                            </tbody>
                        </table>
                    </div>
                    <div class="modal-footer noPrint">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zurück</button>
                        <button type="button" class="btn btn-primary" id="btnPopupPrint" onClick="window.print()">GEMA-Liste drucken</button>
                    </div>
                </div>
            </div>
        </div>
    </body>
    <script>
        const verein = [{
            Vereinsname : 'Musterverein',
            VNameMusikleiter: 'Max',
            NNameMusikleiter: 'Mustermann',
            strasse : 'Musterstraße',
            hNr: '1',
            plz: 12345,
            ort: 'Musterhausen',
            anzMusiker: 35,
            besetzung: 'Blasorchester',
            GEMANr: 234567
        }];

        const inputSearch = document.querySelector("#inputSearch");

        const formGemaListe = document.querySelector("#formGemaListe");

        const modalGemaListe = new bootstrap.Modal("#modalGemaListe");

        const btnVereinsdaten = document.querySelector('#btn-vereinsdaten-aendern');
        const btnGemaListe = document.querySelector('#btnCreateGemaListe');
        const tableTitles = document.querySelector('#table-titles');
        const tableTitlesPopup = document.querySelector('#table-titles-popup');
        const save = document.querySelector('#btn_save_Vereinsdaten');

        window.addEventListener("DOMContentLoaded", (event) => {
            init();

            btnVereinsdaten.addEventListener("click", showVereinsdaten);

            btnGemaListe.addEventListener("click", (event) => {
                const items = getSelectedItems();
                createGEMATableEntries(items);
                
                modalGemaListe.show();
            });

            save.addEventListener("click", checkVereinsdaten);

            inputSearch.addEventListener("input", (event) => {
                searchTitle();
            });
        });

        async function init() {
            // Load titles from Backend
            const titlesArr = await fetch('http://localhost:8000/api/lied/alle')
                .then((response) => response.json());

            // Create table row elements
            titlesArr.forEach((title) => {
                addTableEntry(title);
            });

            updateButtonStates();
        }

        function getSelectedItems() {
            let selectedElements = document.querySelectorAll("tr.selected");
            let items = [];
            selectedElements.forEach((element) => {
                items.push(element.dataset);
            });
            return items;
        }

        function createGEMATableEntries(titles) {
            tableTitlesPopup.innerHTML = "";

            let i = 1;
            titles.forEach((titleObj) => {
                let tr = document.createElement("tr");
            
                let tdNr = document.createElement("td");
                tdNr.innerText = i + ".";
                tr.appendChild(tdNr);

                let tdTitel = document.createElement("td");
                tdTitel.innerText = titleObj.titel;
                tr.appendChild(tdTitel);

                let tdKomponist = document.createElement("td");
                tdKomponist.innerText = titleObj.komponist_name;
                tr.appendChild(tdKomponist);

                let tdBearbeiter = document.createElement("td");
                tdBearbeiter.innerText = titleObj.bearbeiter_name;
                tr.appendChild(tdBearbeiter);

                let tdVerlag = document.createElement("td");
                tdVerlag.innerText = titleObj.verlag_name;
                tr.appendChild(tdVerlag);

                tableTitlesPopup.appendChild(tr);
                i++;
            });
        }

        function createTableEntry(titleObj) {
            let tr = document.createElement("tr");
            tr.setAttribute("id", "table-row-title-" + titleObj.id);
            tr.addEventListener("click", () => {
                const checkbox = document.querySelector("#checkbox-title-" + titleObj.id);

                if (tr.classList.contains("selected")) {
                    tr.classList.remove("selected");
                    checkbox.checked = false;
                } else {
                    tr.classList.add("selected");
                    checkbox.checked = true;
                }

                updateButtonStates();
            });
            
            let tdCheckbox = document.createElement("td");
            let inputCheckbox = document.createElement("input");
            inputCheckbox.classList.add("form-check-input");
            inputCheckbox.setAttribute("type", "checkbox");
            inputCheckbox.setAttribute("id", "checkbox-title-" + titleObj.id);
            tdCheckbox.appendChild(inputCheckbox);
            tr.appendChild(tdCheckbox);

            let tdTitel = document.createElement("td");
            tdTitel.innerText = titleObj.titel;
            tr.appendChild(tdTitel);

            let tdKomponist = document.createElement("td");
            tdKomponist.innerText = titleObj.komponist_name;
            tr.appendChild(tdKomponist);

            let tdBearbeiter = document.createElement("td");
            tdBearbeiter.innerText = titleObj.bearbeiter_name;
            tr.appendChild(tdBearbeiter);

            let tdVerlag = document.createElement("td");
            tdVerlag.innerText = titleObj.verlag_name;
            tr.appendChild(tdVerlag);

            tr.dataset.id = titleObj.id;
            tr.dataset.titel = titleObj.titel;
            tr.dataset.komponist_id = titleObj.komponist_id;
            tr.dataset.komponist_name = titleObj.komponist_name;
            tr.dataset.bearbeiter_id = titleObj.bearbeiter_id;
            tr.dataset.bearbeiter_name = titleObj.bearbeiter_name;
            tr.dataset.verlag_id = titleObj.verlag_id;
            tr.dataset.verlag_name = titleObj.verlag_name;

            return tr;
        }

        function addTableEntry(titleObj) {
            tableTitles.appendChild(createTableEntry(titleObj));
        }

        function updateButtonStates() {
            let selectedElements = document.querySelectorAll("tr.selected");

            if (selectedElements.length == 0) {
                btnGemaListe.disabled = true;
            } else if (selectedElements.length >= 1) {
                btnGemaListe.disabled = false;
            }
        }

        function addOptionsToSelectElement(selectElement, optionsArr) {
            optionsArr.forEach((option) => {
                let optionElem = document.createElement("option");
                optionElem.value = option.id;
                optionElem.innerText = option.name;
                selectElement.appendChild(optionElem);
            });
        }

        function showVereinsdaten(){
            verein.forEach(v => {
                const NameKapelle = document.querySelector('#NameKapelle');
                NameKapelle.value = v.Vereinsname;
                const MusikleiterVname = document.querySelector('#MusikleiterVname');
                MusikleiterVname.value = v.VNameMusikleiter;
                const MusikleiterNname = document.querySelector('#MusikleiterNname');
                MusikleiterNname.value = v.NNameMusikleiter;
                const StrasseVerein = document.querySelector('#StrasseVerein');
                StrasseVerein.value = v.strasse;
                const HNrVerein = document.querySelector('#HNrVerein');
                HNrVerein.value = v.hNr;
                const PlzVerein = document.querySelector('#PlzVerein');
                PlzVerein.value = v.plz;
                const OrtVerein = document.querySelector('#OrtVerein');
                OrtVerein.value = v.ort;
                const AnzMusizierende = document.querySelector('#AnzMusizierende');
                AnzMusizierende.value = v.anzMusiker;
                const GemaMitgliedNr = document.querySelector('#GemaMitgliedNr');
                GemaMitgliedNr.value = v.GEMANr;
                const Besetzung = document.querySelector('#Besetzung');
                Besetzung.value = v.besetzung;
            });
        }

        function checkVereinsdaten(){
            verein.forEach(v => {
                const NameKapelle = document.querySelector('#NameKapelle');
                v.Vereinsname = NameKapelle.value;
                const MusikleiterVname = document.querySelector('#MusikleiterVname');
                v.VNameMusikleiter = MusikleiterVname.value;
                const MusikleiterNname = document.querySelector('#MusikleiterNname');
                v.NNameMusikleiter = MusikleiterNname.value;
                const StrasseVerein = document.querySelector('#StrasseVerein');
                v.strasse = StrasseVerein.value;
                const PlzVerein = document.querySelector('#PlzVerein');
                v.plz = PlzVerein.value;
                const OrtVerein = document.querySelector('#OrtVerein');
                v.ort = OrtVerein.value;
                const AnzMusizierende = document.querySelector('#AnzMusizierende');
                v.anzMusiker = AnzMusizierende.value;
                const GemaMitgliedNr = document.querySelector('#GemaMitgliedNr');
                v.GEMANr = GemaMitgliedNr.value;
                const Besetzung = document.querySelector('#Besetzung');
                v.besetzung = Besetzung.value;
            });
        }

        async function searchTitle() {
            // Remove old table entries
            tableTitles.innerHTML = "";
            
            // Get matched titles from Backend
            let apiLink = "http://localhost:8000/api/lied/such/" + inputSearch.value;
            // If search input is empty get all titles
            if (inputSearch.value.trim() == "") {
                apiLink = "http://localhost:8000/api/lied/alle";
            }
            const titlesArr = await fetch(apiLink)
                .then((response) => response.json());

            // Create table row elements
            titlesArr.forEach((title) => {
                addTableEntry(title);
            });

            updateButtonStates();
        }
    </script>
</html>